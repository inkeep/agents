FROM node:22-alpine

WORKDIR /app

# Install pnpm
RUN npm install -g pnpm@10.17.0

# Copy package files first for better caching
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml turbo.json ./
COPY patches/ ./patches/

# Copy all package.json files to enable pnpm fetch
COPY packages/agents-core/package.json ./packages/agents-core/
COPY packages/agents-manage-mcp/package.json ./packages/agents-manage-mcp/
COPY agents-manage-api/package.json ./agents-manage-api/

# Fetch dependencies
RUN pnpm fetch

# Copy source code
COPY packages/agents-core/ ./packages/agents-core/
COPY packages/agents-manage-mcp/ ./packages/agents-manage-mcp/
COPY agents-manage-api/ ./agents-manage-api/
COPY tsdown.config.ts ./

# Install dependencies
RUN pnpm install --frozen-lockfile --offline

# Build packages in order (increase memory for TypeScript compilation)
ENV NODE_OPTIONS="--max-old-space-size=4096"

WORKDIR /app/packages/agents-core
RUN pnpm build

WORKDIR /app/packages/agents-manage-mcp
RUN pnpm tsdown

WORKDIR /app/agents-manage-api
RUN pnpm build

# Create production server wrapper
RUN echo 'import { serve } from "@hono/node-server"; \
import app from "./dist/index.js"; \
const honoApp = app.default || app; \
console.log("Starting Manage API in production mode..."); \
serve({ fetch: honoApp.fetch, port: 3002 }, (info) => { \
  console.log("Manage API listening on http://localhost:" + info.port); \
});' > server.mjs

# Apply clean-package to agents-core to fix exports for production
WORKDIR /app/packages/agents-core
RUN pnpm clean-package

WORKDIR /app/agents-manage-api

EXPOSE 3002

CMD ["node", "server.mjs"]


