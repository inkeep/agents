{
  "name": "Fix CLI Port Mismatch and Centralize Local URLs",
  "description": "Fix the port 3001 bug in inkeep init --local, centralize all hardcoded localhost URLs around the LOCAL_REMOTE constant, split profile add 'Custom' into Local/Custom options, remove dead code, and update documentation. Full spec with before/after code: SPEC-fix-cli-port-mismatch.md",
  "branch": "ralph/fix-cli-port-mismatch",
  "stories": [
    {
      "id": "US-001",
      "title": "Remove dead DEFAULT_LOCAL_PROFILE constant",
      "description": "Remove the unused DEFAULT_LOCAL_PROFILE constant from types.ts and its re-export from the barrel index.ts. This constant was created in PR #1395 but has never been imported by any other file. Removing it before other changes avoids confusion about what to use.",
      "priority": 1,
      "passes": false,
      "acceptance_criteria": [
        "Remove the DEFAULT_LOCAL_PROFILE export and its JSDoc comment from agents-cli/src/utils/profiles/types.ts (the const declaration around line 130-138)",
        "Remove DEFAULT_LOCAL_PROFILE from the re-export list in agents-cli/src/utils/profiles/index.ts",
        "LOCAL_REMOTE constant in types.ts is NOT removed — only DEFAULT_LOCAL_PROFILE",
        "Grep the entire agents-cli/src directory to confirm zero remaining references to DEFAULT_LOCAL_PROFILE",
        "Typecheck passes: run cd agents-cli && npx tsc --noEmit"
      ],
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Fix port 3001 bug in init.ts and update tests",
      "description": "The core bug: inkeep init --local writes manageUi: 'http://localhost:3001' but the dashboard runs on port 3000. Fix by importing LOCAL_REMOTE from '../utils/profiles' and replacing all 4 hardcoded localhost URLs in init.ts. Then update the 3 test expectations that assert the wrong port.",
      "priority": 2,
      "passes": false,
      "acceptance_criteria": [
        "Add LOCAL_REMOTE to the existing import from '../utils/profiles' in agents-cli/src/commands/init.ts (around line 6-11)",
        "Line ~390: change apiUrl = 'http://localhost:3002' to apiUrl = LOCAL_REMOTE.api",
        "Lines ~423-424: change placeholder and initialValue from 'http://localhost:3002' to LOCAL_REMOTE.api",
        "Line ~456: change manageUi: 'http://localhost:3001' to manageUi: LOCAL_REMOTE.manageUi (THIS IS THE BUG FIX)",
        "In agents-cli/src/__tests__/commands/init.test.ts: change all 3 instances of manageUi: 'http://localhost:3001' to manageUi: 'http://localhost:3000' (around lines 276, 313, 337)",
        "Typecheck passes: run cd agents-cli && npx tsc --noEmit",
        "Tests pass: run cd agents-cli && npx vitest run src/__tests__/commands/init.test.ts"
      ],
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Centralize runtime fallback URLs in profile-config.ts and config.ts",
      "description": "Two more files have hardcoded localhost URLs as fallback defaults. Replace them with LOCAL_REMOTE references.",
      "priority": 3,
      "passes": false,
      "acceptance_criteria": [
        "In agents-cli/src/utils/profile-config.ts: add LOCAL_REMOTE to the existing import from './profiles'",
        "In profile-config.ts around lines 51-52: change agentsApiUrl: 'http://localhost:3002' to agentsApiUrl: LOCAL_REMOTE.api and manageUiUrl: 'http://localhost:3000' to manageUiUrl: LOCAL_REMOTE.manageUi",
        "In agents-cli/src/utils/config.ts: add new import line: import { LOCAL_REMOTE } from './profiles';",
        "In config.ts around lines 333-334: change agentsApiUrl: 'http://localhost:3002' to agentsApiUrl: LOCAL_REMOTE.api and manageUiUrl: 'http://localhost:3000' to manageUiUrl: LOCAL_REMOTE.manageUi",
        "No other hardcoded 'localhost:3002' or 'localhost:3000' strings remain in these two files (except JSDoc @default annotations which are documentation-only)",
        "Typecheck passes: run cd agents-cli && npx tsc --noEmit"
      ],
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Split profile add Custom into Local and Custom options",
      "description": "The profile add command has Cloud and Custom options. Split Custom into Local and Custom. Local auto-sets URLs from LOCAL_REMOTE and credential to 'none' (no prompts needed). Custom removes localhost defaults and uses descriptive placeholders for self-hosted/staging users. Also fix environment default and skip keychain warning for credential 'none'. Read SPEC-fix-cli-port-mismatch.md Change 4 (4a through 4f) for exact before/after code.",
      "priority": 4,
      "passes": false,
      "acceptance_criteria": [
        "In agents-cli/src/commands/profile.ts: add LOCAL_REMOTE to the existing import from '../utils/profiles' (line 3)",
        "The remote type select (around line 74-80) has 3 options: Inkeep Cloud (value 'cloud'), Local (value 'local', hint 'Local development (localhost)'), Custom (value 'custom', hint 'Self-hosted or staging deployment')",
        "When remoteType is 'local': remote is set to { ...LOCAL_REMOTE } with NO URL prompts shown to user",
        "When remoteType is 'custom': URL prompts have NO initialValue, only placeholder hints like 'https://your-agents-api.example.com' and 'https://your-manage-ui.example.com', and validate rejects empty input",
        "Environment default: 'development' when remoteType is 'local', 'production' otherwise (cloud and custom)",
        "Credential: when remoteType is 'local', credential is auto-set to 'none' with NO credential prompt. Cloud and custom still show the credential prompt with default 'inkeep-<name>'",
        "The keychain warning block (around lines 182-188) is wrapped in: if (credential !== 'none') { ... } so it skips for local profiles",
        "Typecheck passes: run cd agents-cli && npx tsc --noEmit"
      ],
      "notes": "This is the largest change. Read the full spec Change 4 sections 4a-4f in SPEC-fix-cli-port-mismatch.md for exact before/after code blocks."
    },
    {
      "id": "US-005",
      "title": "Update CLI reference docs in cli-reference.mdx",
      "description": "Three fixes to agents-docs/content/typescript-sdk/cli-reference.mdx: (1) Fix the stale profile YAML example that uses wrong field names from before the mono-API refactor, (2) Add inkeep login and inkeep logout as proper command subsections, (3) Update the profile add description to reflect Cloud/Local/Custom options.",
      "priority": 5,
      "passes": false,
      "acceptance_criteria": [
        "The profile YAML example (around lines 739-754) uses correct field names: 'api' (not 'manageApi'), no 'runApi' field, credential is 'none' for local profiles (not 'inkeep-local')",
        "New ### inkeep login subsection exists with description of device code flow, --profile option, and note about credential: none",
        "New ### inkeep logout subsection exists with description and --profile option",
        "The login/logout sections are placed after the inkeep profile section and before inkeep add",
        "Each new section is wrapped in a <SkillRule> component matching the pattern of other command sections in the file",
        "The profile add bullet description mentions Cloud, Local, and Custom options",
        "No broken MDX syntax — file renders correctly"
      ],
      "notes": "Check existing command sections in cli-reference.mdx for the SkillRule wrapper pattern before writing new sections."
    },
    {
      "id": "US-006",
      "title": "Add CLI troubleshooting docs and fix setup-profile.mdx",
      "description": "Two doc files need updates: (1) Add a CLI Issues section to agents-docs/content/troubleshooting.mdx covering login failures, device code expiry, and push auth errors. (2) Fix Step 1 in agents-docs/content/guides/cli/setup-profile.mdx to branch Cloud/Local/Custom instead of telling all users to select Custom.",
      "priority": 6,
      "passes": false,
      "acceptance_criteria": [
        "In troubleshooting.mdx: new ## CLI Issues section inserted after the service logs section and before Common Configuration Issues",
        "CLI Issues section has subsections for: login fails / connection refused, device code expired, push fails with auth errors",
        "Each subsection has actionable bullet points mentioning commands like 'inkeep profile current' and 'inkeep dev'",
        "In guides/cli/setup-profile.mdx: Step 1 describes all three remote type options (Inkeep Cloud, Local, Custom) with when to use each",
        "No broken MDX syntax in either file"
      ],
      "notes": "Read SPEC-fix-cli-port-mismatch.md Doc Changes 4 and 5 for exact proposed content."
    }
  ]
}
