name: Claude PR Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  pr-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Full history for merge-base

      - name: Get PR Diff
        id: diff
        run: |
          # Get the diff for the PR
          DIFF=$(git diff origin/${{ github.event.pull_request.base.ref }}...HEAD)

          # Store in file to handle large diffs and special characters
          echo "$DIFF" > /tmp/pr-diff.txt

          # Also get changed files list
          FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD)
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run PR Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          track_progress: true
          include_fix_links: true
          use_sticky_comment: true
          claude_args: |
            --agent pr-review
            --allowedTools "Task,Read,Grep,Glob,Bash(git diff:*),Bash(git log:*),Bash(git show:*),Bash(git merge-base:*),Bash(gh pr comment:*)"
          direct_prompt: |
            Review this pull request.

            Base branch: ${{ github.event.pull_request.base.ref }}
            PR number: ${{ github.event.pull_request.number }}

            ## Changed Files
            ```
            ${{ steps.diff.outputs.changed_files }}
            ```

            ## Diff
            The full diff is available at /tmp/pr-diff.txt. Read it with the Read tool.

            Skip Phase 1 (Analyze Diff) - the changed files are provided above.
            Proceed directly to Phase 2 (Categorize & Select Reviewers), then dispatch reviewers and aggregate findings.
