name: Deployment Health Check

on:
  repository_dispatch:
    types: [vercel.deployment.ready]

jobs:
  health-check:
    if: |
      contains(github.event.client_payload.deployment.name, 'agents-api') &&
      github.event.client_payload.deployment.environment == 'production'
    runs-on: ubuntu-latest
    steps:
      - name: Debug deployment info
        run: |
          echo "Name: ${{ github.event.client_payload.deployment.name }}"
          echo "URL: ${{ github.event.client_payload.deployment.url }}"
          echo "Environment: ${{ github.event.client_payload.deployment.environment }}"

      - name: Wait for cold start
        run: sleep 10

      - name: Check /health endpoint (liveness)
        run: |
          echo "Checking health endpoint at ${{ github.event.client_payload.deployment.url }}/health"
          curl -f -s -o /dev/null -w "%{http_code}" \
            "${{ github.event.client_payload.deployment.url }}/health" \
            --retry 3 --retry-delay 5

      - name: Check /ready endpoint (readiness)
        run: |
          echo "Checking ready endpoint at ${{ github.event.client_payload.deployment.url }}/ready"
          response=$(curl -f -s "${{ github.event.client_payload.deployment.url }}/ready" \
            --retry 3 --retry-delay 5)
          echo "Response: $response"
          echo "$response" | jq -e '.status == "ok"'

      - name: Notify Vercel (agents-api)
        if: always()
        uses: vercel/repository-dispatch/actions/status@v1
        with:
          name: "Vercel - agents-api: Health Check"
