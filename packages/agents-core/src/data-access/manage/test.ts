import { drizzle } from 'drizzle-orm/node-postgres';
import { Pool } from 'pg';
import * as schema from '../../db/manage/manage-schema';
import { projectExists } from './projects';
import { createProject } from './projects';
import { createAgent } from './agents';
import { createContextConfig } from './contextConfigs';
import { eq } from 'drizzle-orm';

const pool = new Pool({
  connectionString: 'postgresql://appuser:password@localhost:5432/inkeep_agents',
});
const connection = await pool.connect();

connection.query(`SELECT DOLT_CHECKOUT('default_main')`);

const dbClient = drizzle(connection, {
  schema,
  logger: true,
});


const testId = 'test-exact-' + Date.now();

const contextObject = {
  id: testId,
  tenantId: 'default-1',
  projectId: 'default-1',
  agentId: 'default-2',
  headersSchema: {
    type: 'object',
    properties: {
      'x-api-key': { type: 'string' },
    },
    required: ['x-api-key'],
  },
  contextVariables: {
    projectDescription: {
      id: 'project-info',
      trigger: 'initialization' as const,
      fetchConfig: {
        url: 'https://api.management.inkeep.com/graphql',
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        transform: 'data.projectByIntegrationAuth',
        body: {
          query: '\n' +
            '      query GetProjectAutogenInfo {\n' +
            '        projectByIntegrationAuth {\n' +
            '          chatSubjectName\n' +
            '          botCreator\n' +
            '          botName\n' +
            '          oneLineDescription\n' +
            '          primaryLanguage\n' +
            '          autogeneratedDescription\n' +
            '          productLines {\n' +
            '            aliases\n' +
            '            description\n' +
            '            integrations\n' +
            '            primaryTerm\n' +
            '            versions {\n' +
            '                name\n' +
            '                aliases\n' +
            '                description\n' +
            '                releaseDate\n' +
            '                isLatest\n' +
            '            }\n' +
            '          }\n' +
            '          keyTerms {\n' +
            '            primaryTerm\n' +
            '            aliases\n' +
            '            category\n' +
            '            definition\n' +
            '            example\n' +
            '          }\n' +
            '        }\n' +
            '      }'
        },
         responseSchema: {
          type: 'object',
          properties: {
            botName: { type: 'string' },
            keyTerms: { type: 'array', items: { type: 'object', properties: {
              aliases: { type: 'array', items: { type: 'string' } },
              example: { type: 'string' },
              category: { type: 'string' },
              definition: { type: 'string' },
              primaryTerm: { type: 'string' }
            } } },
            botCreator: { type: 'string' },
            productLines: { type: 'array', items: { type: 'object', properties: {
              aliases: { type: 'array', items: { type: 'string' } },
              description: { type: 'string' },
              integrations: { type: 'array', items: { type: 'string' } },
              primaryTerm: { type: 'string' },
              versions: { type: 'array', items: { type: 'object', properties: {
                name: { type: 'string' },
                aliases: { type: 'array', items: { type: 'string' } },
                description: { type: 'string' },
                releaseDate: { type: 'string' },
                isLatest: { type: 'boolean' }
              } } }
            } } },
          },
          required: [
            'botName',
            'keyTerms',
            'botCreator',
            'productLines',
            'chatSubjectName',
            'primaryLanguage',
            'oneLineDescription',
            'autogeneratedDescription'
          ],
          additionalProperties: false
        },
      },
      name: 'Project Information',
      defaultValue: 'Unable to fetch project information'
    }
  },
  createdAt: '2025-12-16T19:24:59.937Z',
  updatedAt: '2025-12-16T19:24:59.937Z'
}

const main = async () => {
  // First, verify the checkout completed
  const branchCheck = await connection.query(`SELECT active_branch()`);
  console.log('Active branch:', branchCheck.rows[0]?.active_branch);
  
  await dbClient.insert(schema.projects)
  .values({
    tenantId: 'default-1',
    id: 'default-1',
    name: 'Facts Project Test',
    description: 'Facts Project',
  })
  .onConflictDoNothing();

  await dbClient.insert(schema.agents)
  .values({
    tenantId: 'default-1',
    projectId: 'default-1',
    id: 'default-2',
    name: 'Inkeep QA Graph Test',
    description: 'Inkeep QA Graph',
  })
  .onConflictDoNothing();

  await dbClient.insert(schema.contextConfigs)
  .values(contextObject)
  const contextConfig = await dbClient.select().from(schema.contextConfigs).where(eq(schema.contextConfigs.id, testId)).limit(1);
  console.log('Context config:', contextConfig);
}
main();


/**
fetchConfig: {
        url: 'https://api.management.inkeep.com/graphql',
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        transform: 'data.projectByIntegrationAuth',
        body: {
          query: '\n' +
            '      query GetProjectAutogenInfo {\n' +
            '        projectByIntegrationAuth {\n' +
            '          chatSubjectName\n' +
            '          botCreator\n' +
            '          botName\n' +
            '          oneLineDescription\n' +
            '          primaryLanguage\n' +
            '          autogeneratedDescription\n' +
            '          productLines {\n' +
            '            aliases\n' +
            '            description\n' +
            '            integrations\n' +
            '            primaryTerm\n' +
            '            versions {\n' +
            '                name\n' +
            '                aliases\n' +
            '                description\n' +
            '                releaseDate\n' +
            '                isLatest\n' +
            '            }\n' +
            '          }\n' +
            '          keyTerms {\n' +
            '            primaryTerm\n' +
            '            aliases\n' +
            '            category\n' +
            '            definition\n' +
            '            example\n' +
            '          }\n' +
            '        }\n' +
            '      }'
        }
      }, 
responseSchema: {
        type: 'object',
        properties: {
          botName: { type: 'string' },
          keyTerms: { type: 'array', items: { type: 'object', properties: {
            aliases: { type: 'array', items: { type: 'string' } },
            example: { type: 'string' },
            category: { type: 'string' },
            definition: { type: 'string' },
            primaryTerm: { type: 'string' }
          } } },
          botCreator: { type: 'string' },
          productLines: { type: 'array', items: { type: 'object', properties: {
            aliases: { type: 'array', items: { type: 'string' } },
            description: { type: 'string' },
            integrations: { type: 'array', items: { type: 'string' } },
            primaryTerm: { type: 'string' },
            versions: { type: 'array', items: { type: 'object', properties: {
              name: { type: 'string' },
              aliases: { type: 'array', items: { type: 'string' } },
              description: { type: 'string' },
              releaseDate: { type: 'string' },
              isLatest: { type: 'boolean' }
            } } }
          } } },
        },
        required: [
          'botName',
          'keyTerms',
          'botCreator',
          'productLines',
          'chatSubjectName',
          'primaryLanguage',
          'oneLineDescription',
          'autogeneratedDescription'
        ],
        additionalProperties: false
      }, */