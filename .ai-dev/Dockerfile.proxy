FROM ubuntu:24.04

# Install Squid with SSL support
RUN apt-get update && \
    apt-get install -y squid-openssl openssl && \
    rm -rf /var/lib/apt/lists/*

# Create SSL directory and generate CA certificate
RUN mkdir -p /etc/squid/ssl /var/lib/squid /var/log/squid && \
    rm -rf /var/lib/squid/ssl_db && \
    openssl req -new -newkey rsa:2048 -days 3650 -nodes -x509 \
        -subj "/C=US/ST=Local/L=Local/O=Squid Proxy/CN=Squid CA" \
        -keyout /etc/squid/ssl/squid-ca.pem \
        -out /etc/squid/ssl/squid-ca.pem && \
    /usr/lib/squid/security_file_certgen -c -s /var/lib/squid/ssl_db -M 4MB && \
    chown -R proxy:proxy /etc/squid/ssl /var/lib/squid /var/log/squid && \
    chmod 700 /etc/squid/ssl

# Copy CA cert for export - make it world readable
RUN openssl x509 -in /etc/squid/ssl/squid-ca.pem -outform PEM -out /etc/squid/ssl/squid-ca.crt && \
    chmod 644 /etc/squid/ssl/squid-ca.crt

EXPOSE 3128

CMD ["squid", "-N"]
