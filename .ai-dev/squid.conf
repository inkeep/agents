# Run as proxy user
cache_effective_user proxy
cache_effective_group proxy

# === SSL Bumping for URL path inspection ===
http_port 3128 ssl-bump \
    cert=/etc/squid/ssl/squid-ca.pem \
    generate-host-certificates=on \
    dynamic_cert_mem_cache_size=4MB

sslcrtd_program /usr/lib/squid/security_file_certgen -s /var/lib/squid/ssl_db -M 4MB

# Bump all SSL traffic for inspection
acl step1 at_step SslBump1
ssl_bump peek step1
ssl_bump bump all

# === Domain ACLs ===
# Allow all *.inkeep.com
acl inkeep_domains dstdomain .inkeep.com

# === URL Path ACLs ===
# Allow only github.com/inkeep/* paths
acl github_inkeep dstdomain github.com
acl github_inkeep_path urlpath_regex ^/inkeep(/|$)

# Allow githubusercontent for inkeep repos
acl githubusercontent dstdomain .githubusercontent.com
acl githubusercontent_inkeep urlpath_regex ^/inkeep(/|$)

# Allow GitHub API for inkeep
acl github_api dstdomain api.github.com
acl github_api_inkeep urlpath_regex ^/repos/inkeep(/|$)

# Anthropic API (required for Claude Code)
acl anthropic dstdomain .anthropic.com

# Claude Code
acl claude dstdomain .claude.com

# === Access Rules ===
acl SSL_ports port 443
acl Safe_ports port 80
acl Safe_ports port 443

http_access deny !Safe_ports

# Allow rules
http_access allow inkeep_domains
http_access allow github_inkeep github_inkeep_path
http_access allow githubusercontent githubusercontent_inkeep
http_access allow github_api github_api_inkeep
http_access allow anthropic
http_access allow claude

# Deny everything else
http_access deny all

# Logging to files (proxy user can write)
access_log /var/log/squid/access.log
cache_log /var/log/squid/cache.log
