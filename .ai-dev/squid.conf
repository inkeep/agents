# Squid proxy — network jail for Claude Code sandbox
# Domain + path filtering with SSL inspection

cache_effective_user proxy
cache_effective_group proxy

# === SSL Bumping (required for URL path inspection) ===
http_port 3128 ssl-bump \
    cert=/etc/squid/ssl/squid-ca.pem \
    generate-host-certificates=on \
    dynamic_cert_mem_cache_size=4MB

sslcrtd_program /usr/lib/squid/security_file_certgen -s /var/lib/squid/ssl_db -M 4MB

acl step1 at_step SslBump1
ssl_bump peek step1
ssl_bump bump all

# === Domain ACLs ===

# Claude Code — required for API calls and authentication
acl anthropic dstdomain .anthropic.com
acl claude dstdomain .claude.com

# npm registry — required for pnpm install
acl npm_registry dstdomain registry.npmjs.org

# Organization domains
acl inkeep_domains dstdomain .inkeep.com

# GitHub API — full domain access (scoped by GITHUB_TOKEN permissions)
acl github_api dstdomain api.github.com

# GitHub git operations — path-restricted to organization repos
acl github dstdomain github.com
acl github_org_path urlpath_regex ^/inkeep(/|$)

# GitHub raw content — path-restricted to organization repos
acl githubusercontent dstdomain .githubusercontent.com
acl githubusercontent_org urlpath_regex ^/inkeep(/|$)

# === Access Rules ===
acl SSL_ports port 443
acl Safe_ports port 80
acl Safe_ports port 443

http_access deny !Safe_ports

# Allow rules
http_access allow anthropic
http_access allow claude
http_access allow npm_registry
http_access allow inkeep_domains
http_access allow github_api
http_access allow github github_org_path
http_access allow githubusercontent githubusercontent_org

# Deny everything else
http_access deny all

# Logging
access_log /var/log/squid/access.log
cache_log /var/log/squid/cache.log
