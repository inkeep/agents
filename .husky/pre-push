#!/bin/sh
# Pre-push hook for Agent Framework
# 
# This hook runs before each push to ensure code quality.
# It performs the following checks:
#   1. Linting (can be skipped with SKIP_LINT=1)
#   2. Type checking (can be skipped with SKIP_TYPECHECK=1)
#   3. Test suite (always runs)
#
# Usage:
#   Normal push:                      git push
#   Skip lint only:                   SKIP_LINT=1 git push
#   Skip typecheck only:              SKIP_TYPECHECK=1 git push  
#   Skip both:                        SKIP_LINT=1 SKIP_TYPECHECK=1 git push
#   Skip all hooks (use sparingly):   git push --no-verify
#
# For more information, see CONTRIBUTING.md

# Get current branch name
BRANCH_NAME=$(git symbolic-ref --short HEAD)

# Only run hooks on main branch
if [ "$BRANCH_NAME" != "main" ]; then
  echo "‚ö° Skipping pre-push hooks (not on main branch)"
  exit 0
fi

# Linting - ensures code quality and consistent formatting
# Can be skipped for emergency fixes or when only touching non-code files
if [ "$SKIP_LINT" = "1" ]; then
  echo "‚ö° Skipping lint check (SKIP_LINT=1)"
else
  echo "üé® Running lint check..."
  # Run lint check using turbo
  if ! pnpm lint; then
    echo "‚ùå Lint issues found. Fix them or use SKIP_LINT=1 git push to bypass (use sparingly!)"
    exit 1
  fi
  echo "‚úÖ Lint check passed"
fi

# Type checking - ensures type safety across all packages
# Can be skipped for WIP pushes or when only touching non-TS files
if [ "$SKIP_TYPECHECK" = "1" ]; then
  echo "‚ö° Skipping typecheck (SKIP_TYPECHECK=1)"
else
  echo "üîç Running typecheck..."
  # Run typecheck
  if ! pnpm typecheck; then
    echo "‚ùå Type errors found. Fix them or use SKIP_TYPECHECK=1 git push to bypass (use sparingly!)"
    exit 1
  fi
  echo "‚úÖ Typecheck passed"
fi

# Test suite - always runs to prevent broken code from being pushed
echo "üß™ Running tests..."
if ! pnpm test; then
  echo "‚ùå Tests failed. Fix them before pushing."
  exit 1
fi
echo "‚úÖ Tests passed"