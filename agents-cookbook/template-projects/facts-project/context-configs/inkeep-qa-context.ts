import { contextConfig, fetchDefinition } from '@inkeep/agents-core';
import { z } from 'zod';
import { inkeepApiKey } from '../credentials/inkeep-api-key';

const projectDescription = fetchDefinition({
  id: 'project-info',
  name: 'Project Information',
  trigger: 'initialization',
  fetchConfig: {
    url: 'https://api.management.inkeep.com/graphql',
    body: {
      query: /* GraphQL */ `
      query GetProjectAutogenInfo {
        projectByIntegrationAuth {
          chatSubjectName
          botCreator
          botName
          oneLineDescription
          primaryLanguage
          autogeneratedDescription
          productLines {
            aliases
            description
            integrations
            primaryTerm
            versions {
                name
                aliases
                description
                releaseDate
                isLatest
            }
          }
          keyTerms {
            primaryTerm
            aliases
            category
            definition
            example
          }
        }
      }`,
    },
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    transform: 'data.projectByIntegrationAuth',
  },
  responseSchema: z
    .object({
      botName: z.union([z.string(), z.null()]),
      keyTerms: z.union([
        z.array(
          z
            .object({
              aliases: z.union([z.array(z.string()), z.null()]),
              example: z.union([z.string(), z.null()]),
              category: z.union([z.string(), z.null()]),
              definition: z.string(),
              primaryTerm: z.string(),
            })
            .strict()
        ),
        z.null(),
      ]),
      botCreator: z.union([z.string(), z.null()]),
      productLines: z.union([
        z.array(
          z
            .object({
              aliases: z.union([z.array(z.string()), z.null()]),
              versions: z.union([
                z.array(
                  z
                    .object({
                      name: z.string(),
                      aliases: z.union([z.array(z.string()), z.null()]),
                      isLatest: z.union([z.boolean(), z.null()]),
                      description: z.string(),
                      releaseDate: z.union([z.string(), z.null()]),
                    })
                    .strict()
                ),
                z.null(),
              ]),
              description: z.string(),
              primaryTerm: z.union([z.string(), z.null()]),
              integrations: z.union([z.array(z.string()), z.null()]),
            })
            .strict()
        ),
        z.null(),
      ]),
      chatSubjectName: z.union([z.string(), z.null()]),
      primaryLanguage: z.union([z.string(), z.null()]),
      oneLineDescription: z.union([z.string(), z.null()]),
      autogeneratedDescription: z.union([z.string(), z.null()]),
    })
    .strict(),
  defaultValue: 'Unable to fetch project information',
  credentialReference: inkeepApiKey,
});

const inkeepQaContext = contextConfig({
  id: 'inkeep-qa-context',
  contextVariables: {
    projectDescription,
  },
});

export { inkeepQaContext, projectDescription };
