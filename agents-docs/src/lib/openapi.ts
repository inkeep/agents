import { readFileSync } from 'node:fs';
import { resolve } from 'node:path';
import { createOpenAPI } from 'fumadocs-openapi/server';

// Read the OpenAPI spec from the local monorepo (generated by agents-api export-openapi script)
function loadLocalSpec() {
  const specPath = resolve(process.cwd(), '../agents-api/openapi-spec.json');
  const specContent = readFileSync(specPath, 'utf-8');
  return JSON.parse(specContent);
}

export const openapi = createOpenAPI({
  // Read the OpenAPI spec from the local monorepo instead of remote URLs.
  // This enables offline builds and ensures docs are always in sync with the codebase.
  // The spec is generated by running `pnpm export-openapi` in agents-api.
  //
  // Multiple document aliases point to the same spec to support different MDX files:
  // - 'agents-api': The unified API spec (new format with /manage/, /run/, /evals/ prefixes)
  // - 'index': Legacy alias for backward compatibility with older MDX files
  // - 'run-api': Legacy alias for run API documentation
  input: () => {
    const spec = loadLocalSpec();
    return {
      'agents-api': spec,
      index: spec,
      'run-api': spec,
    };
  },
});
